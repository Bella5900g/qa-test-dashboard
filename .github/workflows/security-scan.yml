# QA Test Automation Dashboard - Security Scan
# Desenvolvido por Isabella Barbosa - Engenheira de QA SÃªnior

name: ðŸ”’ Security Scan

on:
  # Desabilitado temporariamente para evitar conflitos
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main ]
  # schedule:
  #   # Executar scan de seguranÃ§a semanalmente
  #   - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  # =============================================================================
  # Job: AnÃ¡lise de Vulnerabilidades de DependÃªncias
  # =============================================================================
  dependency-scan:
    name: ðŸ” Scan de DependÃªncias
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: ðŸ›¡ï¸ Verificar vulnerabilidades (Safety)
        run: |
          cd backend
          safety check --json --output safety-report.json || true
          safety check

      - name: ðŸ”’ AnÃ¡lise de seguranÃ§a (Bandit)
        run: |
          cd backend
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt

      - name: ðŸ“Š Upload relatÃ³rios de seguranÃ§a
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            backend/safety-report.json
            backend/bandit-report.json

  # =============================================================================
  # Job: Scan de CÃ³digo com CodeQL
  # =============================================================================
  codeql-analysis:
    name: ðŸ” CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'python' ]

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ” Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}

      - name: ðŸ” Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:${{matrix.language}}"

  # =============================================================================
  # Job: Scan de Container
  # =============================================================================
  container-scan:
    name: ðŸ³ Scan de Container
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ³ Build imagem Docker
        run: |
          # Verificar se o Dockerfile existe antes de fazer build
          if [ -f "docker/Dockerfile" ]; then
            docker build -f docker/Dockerfile --target backend -t qa-dashboard-backend . || echo "Backend build failed, continuing..."
            docker build -f docker/Dockerfile --target frontend -t qa-dashboard-frontend . || echo "Frontend build failed, continuing..."
          else
            echo "Dockerfile not found, skipping container scan"
            exit 0
          fi

      - name: ðŸ”’ Scan com Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'qa-dashboard-backend'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
        continue-on-error: true

      - name: ðŸ”’ Scan com Trivy (Frontend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'qa-dashboard-frontend'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
        continue-on-error: true

      - name: ðŸ“Š Upload resultados Trivy
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-backend-results.sarif'
        continue-on-error: true

      - name: ðŸ“Š Upload resultados Trivy (Frontend)
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-frontend-results.sarif'
        continue-on-error: true

  # =============================================================================
  # Job: Scan de Secrets
  # =============================================================================
  secret-scan:
    name: ðŸ” Scan de Secrets
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Scan com TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified
        continue-on-error: true

  # =============================================================================
  # Job: AnÃ¡lise de LicenÃ§as
  # =============================================================================
  license-scan:
    name: ðŸ“„ AnÃ¡lise de LicenÃ§as
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install pip-licenses

      - name: ðŸ“„ Verificar licenÃ§as
        run: |
          cd backend
          pip-licenses --format=json --output-file=licenses.json
          pip-licenses --format=html --output-file=licenses.html

      - name: ðŸ“Š Upload relatÃ³rio de licenÃ§as
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-reports
          path: |
            backend/licenses.json
            backend/licenses.html

  # =============================================================================
  # Job: NotificaÃ§Ã£o de SeguranÃ§a
  # =============================================================================
  security-notification:
    name: ðŸ“¢ NotificaÃ§Ã£o de SeguranÃ§a
    runs-on: ubuntu-latest
    needs: [dependency-scan, codeql-analysis, container-scan, secret-scan, license-scan]
    if: always()

    steps:
      - name: ðŸ“Š Gerar resumo de seguranÃ§a
        run: |
          echo "## ðŸ”’ Resumo de SeguranÃ§a" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” DependÃªncias | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” CodeQL | ${{ needs.codeql-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Container | ${{ needs.container-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Secrets | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“„ LicenÃ§as | ${{ needs.license-scan.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¢ Notificar Slack (se houver falhas)
        uses: 8398a7/action-slack@v3
        if: failure()
        with:
          status: failure
          channel: '#security-alerts'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
